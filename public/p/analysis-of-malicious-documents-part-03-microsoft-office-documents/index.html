<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="This series was posted originally in the Greater Internet Freedom program website, this is a copy for archiving purposes After checking\u00a0how to set up virtual machines as safe environments\u00a0and presenting an introductory workflow to\u00a0analyze suspicious PDF documents, we are ready to continue with Microsoft Office file formats. Security problems with Microsoft Office documents In general, office documents are not dangerous by themselves if they only contain the information for what they are designed for: pages with text and other printable elements for MS Word, cells with values and formulas for MS Excel, slides with observable elements in MS PowerPoint, etc.">
<title>Analysis of malicious documents – Part 03 – Microsoft Office documents</title>

<link rel='canonical' href='http://localhost:1313/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/'>

<link rel="stylesheet" href="/scss/style.min.b28523dc9ab58fa061e5c1d3fc4cf0b596658650e50850a9e38bb46d54fd77ef.css"><meta property='og:title' content="Analysis of malicious documents – Part 03 – Microsoft Office documents">
<meta property='og:description' content="This series was posted originally in the Greater Internet Freedom program website, this is a copy for archiving purposes After checking\u00a0how to set up virtual machines as safe environments\u00a0and presenting an introductory workflow to\u00a0analyze suspicious PDF documents, we are ready to continue with Microsoft Office file formats. Security problems with Microsoft Office documents In general, office documents are not dangerous by themselves if they only contain the information for what they are designed for: pages with text and other printable elements for MS Word, cells with values and formulas for MS Excel, slides with observable elements in MS PowerPoint, etc.">
<meta property='og:url' content='http://localhost:1313/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/'>
<meta property='og:site_name' content='Carlos Guerra'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts' /><meta property='article:tag' content='maldocs-series' /><meta property='article:published_time' content='2023-01-03T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2023-01-03T00:00:00&#43;00:00'/><meta property='og:image' content='http://localhost:1313/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/11.png' />
<meta name="twitter:title" content="Analysis of malicious documents – Part 03 – Microsoft Office documents">
<meta name="twitter:description" content="This series was posted originally in the Greater Internet Freedom program website, this is a copy for archiving purposes After checking\u00a0how to set up virtual machines as safe environments\u00a0and presenting an introductory workflow to\u00a0analyze suspicious PDF documents, we are ready to continue with Microsoft Office file formats. Security problems with Microsoft Office documents In general, office documents are not dangerous by themselves if they only contain the information for what they are designed for: pages with text and other printable elements for MS Word, cells with values and formulas for MS Excel, slides with observable elements in MS PowerPoint, etc."><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='http://localhost:1313/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/11.png' />
  


    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu99184f921ef7b179b9ae7ead5236baa2_57844_300x0_resize_q75_box.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Carlos Guerra</a></h1>
            <h2 class="site-description">Digital security trainer, auditor, and advisor</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://bsky.app/profile/cguerra.bsky.social'
                        target="_blank"
                        title="Bluesky"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-bluesky"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6.335 5.144c-1.654 -1.199 -4.335 -2.127 -4.335 .826c0 .59 .35 4.953 .556 5.661c.713 2.463 3.13 2.75 5.444 2.369c-4.045 .665 -4.889 3.208 -2.667 5.41c1.03 1.018 1.913 1.59 2.667 1.59c2 0 3.134 -2.769 3.5 -3.5c.333 -.667 .5 -1.167 .5 -1.5c0 .333 .167 .833 .5 1.5c.366 .731 1.5 3.5 3.5 3.5c.754 0 1.637 -.571 2.667 -1.59c2.222 -2.203 1.378 -4.746 -2.667 -5.41c2.314 .38 4.73 .094 5.444 -2.369c.206 -.708 .556 -5.072 .556 -5.661c0 -2.953 -2.68 -2.025 -4.335 -.826c-2.293 1.662 -4.76 5.048 -5.665 6.856c-.905 -1.808 -3.372 -5.194 -5.665 -6.856z" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/CGurity'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://mastodon.social/@CGurity'
                        target="_blank"
                        title="Mastodon"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-mastodon"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18.648 15.254c-1.816 1.763 -6.648 1.626 -6.648 1.626a18.262 18.262 0 0 1 -3.288 -.256c1.127 1.985 4.12 2.81 8.982 2.475c-1.945 2.013 -13.598 5.257 -13.668 -7.636l-.026 -1.154c0 -3.036 .023 -4.115 1.352 -5.633c1.671 -1.91 6.648 -1.666 6.648 -1.666s4.977 -.243 6.648 1.667c1.329 1.518 1.352 2.597 1.352 5.633s-.456 4.074 -1.352 4.944z" /><path d="M12 11.204v-2.926c0 -1.258 -.895 -2.278 -2 -2.278s-2 1.02 -2 2.278v4.722m4 -4.722c0 -1.258 .895 -2.278 2 -2.278s2 1.02 2 2.278v4.722" /></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-home"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l-2 0l9 -9l9 9l-2 0" /><path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" /><path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" /></svg>
                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about-me/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About me</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#security-problems-with-microsoft-office-documents">Security problems with Microsoft Office documents</a></li>
    <li><a href="#macros">Macros</a></li>
    <li><a href="#the-old-and-the-new-ms-office-document-formats">The &ldquo;old&rdquo; and the &ldquo;new&rdquo; MS Office document formats</a></li>
    <li><a href="#analyzing-ms-office-documents">Analyzing MS Office documents</a>
      <ol>
        <li><a href="#oledumppy">Oledump.py</a></li>
      </ol>
    </li>
    <li><a href="#challenges">Challenges</a></li>
    <li><a href="#whats-next">What&rsquo;s next?</a></li>
    <li><a href="#bonus-further-reading-on-ms-office-security">Bonus: Further reading on MS Office security</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/">
                <img src="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/11_hu26eed9cc7c1228930433ac93552fb2d8_79691_800x0_resize_box_3.png"
                        srcset="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/11_hu26eed9cc7c1228930433ac93552fb2d8_79691_800x0_resize_box_3.png 800w, /p/analysis-of-malicious-documents-part-03-microsoft-office-documents/11_hu26eed9cc7c1228930433ac93552fb2d8_79691_1600x0_resize_box_3.png 1600w"
                        width="800" 
                        height="314" 
                        loading="lazy"
                        alt="Featured image of post Analysis of malicious documents – Part 03 – Microsoft Office documents" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/guide/" style="background-color: #00798C; color: #fff;">
                Guide
            </a>
        
            <a href="/categories/author/" style="background-color: #D1495B; color: #fff;">
                Author
            </a>
        
            <a href="/categories/en/" style="background-color: #30638E; color: #fff;">
                EN
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/">Analysis of malicious documents – Part 03 – Microsoft Office documents</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jan 03, 2023</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    10 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <blockquote>
<p>This series was posted originally in the <a class="link" href="https://greaterinternetfreedom.org/course/analysis-of-malicious-documents-part-03-microsoft-office-documents/"  target="_blank" rel="noopener"
    >Greater Internet Freedom program website</a>, this is a copy for archiving purposes</p>
</blockquote>
<p>After checking <a class="link" href="/p/analysis-of-malicious-documents-part-01-introduction-and-vms/" >how to set up virtual machines as safe environments</a> and presenting an introductory workflow to<a class="link" href="/p/analysis-of-malicious-documents-part-02-pdf-documents/" > analyze suspicious PDF documents</a>, we are ready to continue with Microsoft Office file formats.</p>
<h2 id="security-problems-with-microsoft-office-documents">Security problems with Microsoft Office documents
</h2><p>In general, office documents are not dangerous by themselves if they only contain the information for what they are designed for: pages with text and other printable elements for MS Word, cells with values and formulas for MS Excel, slides with observable elements in MS PowerPoint, etc.</p>
<p>However, among the many features available in the MS Office ecosystem to add additional functionality to documents, one is specifically interesting from a digital security perspective: the possibility to embed objects in documents. The kind of objects we can embed are many, like math notation, multimedia, other documents, etc. And among all of them, there is one that is especially powerful because it allows the execution of custom code, which might be weaponized to harm the user: the macro.</p>
<h2 id="macros">Macros
</h2><p>The initial use case for macros In MS documents is to run repetitive tasks easily by &ldquo;recording&rdquo; them once and &ldquo;playing&rdquo; them repeatedly afterward. You can create macros without having any programming knowledge just by recording clicks on buttons and keyboard shortcuts, then MS Office will translate the recording into a series of commands that will be executed as a &ldquo;little program&rdquo; living inside our documents.</p>
<p>When we start diving into how macros work, we start to see how they can be weaponized and why they are so popular in phishing attacks to infect computers vs. other techniques. First, the macros are stored as code written in the Visual Basic for Applications programming language (VBA), which is well documented, simple to write, and powerful. Visual Basic in general is also used for writing entire standalone programs, so it has the capacity to do things outside of the document scope, like downloading and executing files and altering system settings for instance. The associated commands for these tasks are mostly available in MS Office macros as well, so we can write macros that take advantage of the advanced commands available and use them to execute harmful tasks, like download and execute more advanced malware, delete files, etc.</p>
<p>Second, executing macros from documents is really easy. Document creators can configure them to run automatically when opening the file, when clicking a button, link, or any given element, among other triggers. Then for unknown files, MS Office will warn us that their macros might be dangerous and will block them, but we are usually one or two clicks away from disabling this protection and running the macros anyway. This situation makes it very attractive for malicious actors to use macros and convince us that they are safe to run through convincing arguments proper to each phishing campaign.</p>
<p>Comparing PDFs to MS Office documents with macros for malicious activities, MS Office docs offer more possibilities of commands to run on devices opening them, making them more powerful, and also more popular, than PDFs. Also, that flexibility is the reason we are focusing on weaponizing allowed macros inside malicious documents vs. other ways of weaponizing MS Office documents. If you are interested in different ways these files might be used to vulnerate users of outdated office versions, in the end, we are providing links to other references.</p>
<blockquote>
<p><strong>Office vulnerabilities</strong><br>
There are many documented ways used to exploit macros or office documents in general, however, many of the most creative ones are not possible to exploit in fully updated instances of ms office.<br>
As any other program, MS Office might have known or unknown vulnerabilities that could allow to a device compromise, even without using macros.</p>
</blockquote>
<h2 id="the-old-and-the-new-ms-office-document-formats">The &ldquo;old&rdquo; and the &ldquo;new&rdquo; MS Office document formats
</h2><p>Since 2003, Microsoft Office changed the way documents are created by default, including new file extensions, so new MS Word documents are stored with the &ldquo;.docx&rdquo; extension instead of &ldquo;.doc&rdquo; and so on. Even when the internal structure of these two file formats is different, macros are stored in a similar way, then the guidance provided in this material applies to both old and new file formats.</p>
<blockquote>
<p>If you are interested in knowing more about the conventions to store macros and many other kinds of objects, you can research more about Object Linking and Embedding (or OLE), which is still used and adapted to new file formats, including MS Office documents</p>
</blockquote>
<h2 id="analyzing-ms-office-documents">Analyzing MS Office documents
</h2><p>To start exploring ways to detect when macros are included in MS Office documents, we&rsquo;ll use <a class="link" href="https://blog.didierstevens.com/programs/oledump-py/"  target="_blank" rel="noopener"
    >oledump.py</a>, a Python tool developed by Didier Stevens, the same author of the tools proposed previously in the previous part focused on PDFs. We&rsquo;ll be also using a series of <a class="link" href="https://conference.hitb.org/hitbsecconf2017ams/materials/D1T3%20-%20Didier%20Stevens%20-%20Analyzing%20Malicious%20Office%20Documents.pdf"  target="_blank" rel="noopener"
    >example files</a> to show how MS Office documents work and how macros can be detected and reviewed, also from training materials from Didier Stevens.</p>
<p>The workflow to start the analysis of MS Office documents is very similar to the one we used on PDFs. First, we list the different elements present in the file, we identify interesting objects in terms of security, and then we try to get the actual content of those elements to see if there is anything harmful there.</p>
<h3 id="oledumppy">Oledump.py
</h3><p>The main use of this tool is to list any OLE objects included in any specific file, and show the content of any of them. The basic use of the tool is as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">oledump.py ex001.doc
</span></span></code></pre></td></tr></table>
</div>
</div><p>Where ex001.doc is the name of the document we want to analyze</p>
<p><img src="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/1.png"
	width="768"
	height="209"
	srcset="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/1_hu9de6a6317d0b75b4b2ba7c5c7931f30a_53242_480x0_resize_box_3.png 480w, /p/analysis-of-malicious-documents-part-03-microsoft-office-documents/1_hu9de6a6317d0b75b4b2ba7c5c7931f30a_53242_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="367"
		data-flex-basis="881px"
	
></p>
<p>Here we can see all the elements for a file without macros or other unusual objects embedded in an “old” MS Office filetype, doing the same experiment for a file with the “new” format (after MS Office 2003), we will get something like this.</p>
<p><img src="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/2.png"
	width="768"
	height="132"
	srcset="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/2_hua8ab82f50cef766a417edbc6406abbde_40191_480x0_resize_box_3.png 480w, /p/analysis-of-malicious-documents-part-03-microsoft-office-documents/2_hua8ab82f50cef766a417edbc6406abbde_40191_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="581"
		data-flex-basis="1396px"
	
></p>
<p>Here we can see that more elements in the .doc example are stored as OLE objects, while in the .docx example, we have a functional document without using OLE objects. This is because .docx documents are packaged as a .zip file with mostly .xml files inside (you can even try to change a safe .docx|.xlsx|.pptx file to the .zip extension and open it), and only use OLE-formatted data when needed.</p>
<p>When we open a file with macros, the result will include new elements:</p>
<p><img src="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/3.png"
	width="768"
	height="301"
	srcset="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/3_hue22314a055ce99d53db813a9c036c07a_79973_480x0_resize_box_3.png 480w, /p/analysis-of-malicious-documents-part-03-microsoft-office-documents/3_hue22314a055ce99d53db813a9c036c07a_79973_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="255"
		data-flex-basis="612px"
	
></p>
<blockquote>
<p>If we look closely at this example, we can see that the file that we passed to the command is a zip file, in this case, this is a .zip file containing a MS word document. Also, the .zip file is password-protected with the password “infected”. This is a common practice in the malware analysis community, and oledump.py considers it as a valid input and manages all the decompression, and passes the document for analysis automatically for us.</p>
</blockquote>
<p>In this output, we see 2 objects that are different, and they are identified with the letter &ldquo;m&rdquo; or &ldquo;M&rdquo;. This means that those specific objects contain macros. Let&rsquo;s use the <code>-s</code> command in oledump.py to see the content of those streams, starting with the object (or stream 8)</p>
<p><img src="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/4.png"
	width="768"
	height="239"
	srcset="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/4_hu750fc4c0480acf652616a705ec67d90b_73486_480x0_resize_box_3.png 480w, /p/analysis-of-malicious-documents-part-03-microsoft-office-documents/4_hu750fc4c0480acf652616a705ec67d90b_73486_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="321"
		data-flex-basis="771px"
	
></p>
<p>We used the command <code>-s</code> to select the object identified with the number 8, and the command <code>-v</code> to decompress the content because VBA might compress code by default, so it is a safe practice to include this command when requesting objects with macros.</p>
<p>Now, looking at the content, we see some attribute declarations, these are done by default by VBA and they are not even visible to the document creator, then, this code is not considered custom or harmful to our effects. That said, code known to be harmless by the tool is identified with a lowercase &ldquo;m&rdquo;, assuming it as safe and less interesting for further analysis. Let&rsquo;s analyze the other object containing a macro.</p>
<p><img src="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/5.png"
	width="768"
	height="178"
	srcset="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/5_hu598451a33e8f3cc402e8396588e03b58_44242_480x0_resize_box_3.png 480w, /p/analysis-of-malicious-documents-part-03-microsoft-office-documents/5_hu598451a33e8f3cc402e8396588e03b58_44242_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="431"
		data-flex-basis="1035px"
	
></p>
<p>To give some context, this macro uses the MsgBox command that launches a dialog window with the message “Hello world” in this case. Also, AutoOpen() tells the program that this macro should be executed when opening the file automatically. In practice, an unknown document trying to execute an AutoOpen() macro will trigger a security alert, however, depending on the context, the user might be tricked into bypassing the warning and executing the macro anyway.</p>
<p>To explore the way this might be weaponized, let’s check the following file</p>
<p><img src="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/6.png"
	width="768"
	height="286"
	srcset="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/6_hu99d613a82c64edb8a4acd780d38bad1b_80390_480x0_resize_box_3.png 480w, /p/analysis-of-malicious-documents-part-03-microsoft-office-documents/6_hu99d613a82c64edb8a4acd780d38bad1b_80390_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="268"
		data-flex-basis="644px"
	
></p>
<p><img src="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/7.png"
	width="768"
	height="439"
	srcset="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/7_hufc3e1585665a70f542f6fa1a6f7c9200_129767_480x0_resize_box_3.png 480w, /p/analysis-of-malicious-documents-part-03-microsoft-office-documents/7_hufc3e1585665a70f542f6fa1a6f7c9200_129767_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="174"
		data-flex-basis="419px"
	
></p>
<p>Here, the macro of interest is a little more complex than a dialog window with a text message, we can see that again, the AutoOpen() feature is used to execute the code below when opening the document. Looking at the code, with a little help checking the used commands, we can infer that the macro tries to download the content of an URL into a file in the temporal directory of our machine and execute whatever file was downloaded.</p>
<p>In this case, it seems that the file is filling a text file, which should be harmless, but with the right URL and the right filetype used to download the content, a macro like this one can write and execute programs or other harmful artifacts without much user interaction or even knowledge. Also, it is worth mentioning that this macro is a simplified version of more real threats, which usually obfuscate their code to avoid detection by antivirus software and can execute more elaborated actions, like adding the downloaded malware to startup programs or scheduled tasks, so the malware is persistent over time, among others.</p>
<p>Often, analyzing more complex macros will require skills not covered in this material, like decrypting code and figuring out how, through the use of different commands and data structures, we can get the final executed code so we can understand what it does (de-obfuscation). A still very simple example showing a common technique to obfuscate content can be found checking the next file.</p>
<p><img src="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/8.png"
	width="768"
	height="301"
	srcset="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/8_hu933e65e6409314028aa6c89699a32b8e_79904_480x0_resize_box_3.png 480w, /p/analysis-of-malicious-documents-part-03-microsoft-office-documents/8_hu933e65e6409314028aa6c89699a32b8e_79904_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="255"
		data-flex-basis="612px"
	
></p>
<p><img src="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/9.png"
	width="768"
	height="562"
	srcset="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/9_hu94ab00b005fcd3ab57455d169f892838_105750_480x0_resize_box_3.png 480w, /p/analysis-of-malicious-documents-part-03-microsoft-office-documents/9_hu94ab00b005fcd3ab57455d169f892838_105750_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="136"
		data-flex-basis="327px"
	
></p>
<p>Here, instead of using plain text, the creator of the macro used the encoding scheme base64, which makes more difficult to read the payload they are trying to execute. For this example, there are many tools that can help us decode that variable, one of them is <a class="link" href="https://gchq.github.io/CyberChef/"  target="_blank" rel="noopener"
    >CyberChef</a>, a web application where we can input some data, and execute some operations to it to get an output, in this case we have:</p>
<p><img src="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/10.jpg"
	width="768"
	height="372"
	srcset="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/10_hu4465fde59de6f9ac944cc3a12694eb47_25356_480x0_resize_q75_box.jpg 480w, /p/analysis-of-malicious-documents-part-03-microsoft-office-documents/10_hu4465fde59de6f9ac944cc3a12694eb47_25356_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="206"
		data-flex-basis="495px"
	
></p>
<p>With these examples and references, we should be able to know if a file has macros embedded using oledump.py, if a file is interesting to analyze further, and in case its code is simple enough, what the macro is trying to do. In the case of finding documents with very complex macros, the advice is to look for help to analyze the file more in-depth and never try to execute the file in our environments because it could have terrible effects on our devices in case they get infected.</p>
<p>Now that we learned some introductory workflows to analyze PDFs and MS Office files, we are ready to review some defensive strategies to protect ourselves of malicious documents in the next and final part.</p>
<h2 id="challenges">Challenges
</h2><p><strong>Question:</strong> applying the same workflow to the file <a class="link" href="https://drive.google.com/file/d/13b9TXYWUVt75gz1xjYxFFS-ZocRg2oqQ/view?usp=sharing"  target="_blank" rel="noopener"
    >ex006.doc.zip</a> we see this output, Which of the following hypothesis check out with the information we got so far?</p>
<p><img src="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/11.png"
	width="768"
	height="301"
	srcset="/p/analysis-of-malicious-documents-part-03-microsoft-office-documents/11_hu26eed9cc7c1228930433ac93552fb2d8_79691_480x0_resize_box_3.png 480w, /p/analysis-of-malicious-documents-part-03-microsoft-office-documents/11_hu26eed9cc7c1228930433ac93552fb2d8_79691_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="255"
		data-flex-basis="612px"
	
></p>
<p><details>
    <summary>1. The file doesn’t have any macros</summary>
    <div><strong>Incorrect</strong> &ndash;</div>
</details><br>
<details>
    <summary>2. The file has custom created macros as any of the other examples covered</summary>
    <div><strong>Incorrect</strong> &ndash;</div>
</details><br>
<details>
    <summary>3. The file somehow has system harmless macros but not any custom created macros</summary>
    <div><strong>Correct</strong> &ndash;</div>
</details></p>
<p><strong>Question:</strong> applying the same workflow to the file <a class="link" href="https://greaterinternetfreedom.org/wp-content/uploads/2023/07/ex016.doc.zip"  target="_blank" rel="noopener"
    >ex016.doc.zip</a> we see a macro similar to the last one covered above, where the macro decodes something in base64. What is being passed to the Decode64 function? (hint: aaaaaaaaaaaaaa.aaaaaaa.aaaa)</p>
<p><img src="/12.png"
	
	
	
	loading="lazy"
	
	
></p>
<details>
    <summary>I want to see the answer</summary>
    <div>ActiveDocument.Content.Text</div>
</details>
<h2 id="whats-next">What&rsquo;s next?
</h2><p>After having a better idea of how PDF and MS Office can be assessed for malicious code, we can understand better how to propose <a class="link" href="#" >defensive measures, and also, we can review final tips</a> on how to conduct this kind of initial assessment.</p>
<h2 id="bonus-further-reading-on-ms-office-security">Bonus: Further reading on MS Office security
</h2><ul>
<li><a class="link" href="https://github.com/decalage2/oletools"  target="_blank" rel="noopener"
    >Oletools</a>: another famous tool to analyze MS Office files</li>
<li><a class="link" href="https://www.cvedetails.com/vulnerability-list/vendor_id-26/product_id-320/Microsoft-Office.html"  target="_blank" rel="noopener"
    >List of known vulnerabilities of Microsoft Office</a> (mostly not involving macros)</li>
<li><a class="link" href="https://resources.infosecinstitute.com/topic/follina-microsoft-office-code-execution-vulnerability/"  target="_blank" rel="noopener"
    >CVE-2022-30190 or codename &ldquo;Follina&rdquo;:</a> a recent trendy vulnerability abusing documents to interact with Windows troubleshooting features.</li>
<li><a class="link" href="https://redcanary.com/blog/malicious-excel-macro/"  target="_blank" rel="noopener"
    >&ldquo;Uncompromised: Unpacking a malicious Excel macro&rdquo;,</a> an interesting case exploring a malicious file step by step.</li>
<li><a class="link" href="https://zeltser.com/analyzing-malicious-documents/"  target="_blank" rel="noopener"
    >Analyzing Malicious Documents Cheat Sheet</a>, Lenny Zeltser&rsquo;s quick guidance to analyze suspicious documents.</li>
</ul>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/maldocs-series/">Maldocs-Series</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/analysis-of-malicious-documents-part-04-defensive-measures-next-steps-and-closure/">
        
        
            <div class="article-image">
                <img src="/p/analysis-of-malicious-documents-part-04-defensive-measures-next-steps-and-closure/1.aeb286b75baecbb347674d142d4c8f99_hu47a86cfd803a9df7c9cd05ac2ffab0be_30367_250x150_fill_q75_box_smart1.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Analysis of malicious documents – Part 04 – Defensive measures, next steps, and closure"
                        
                        data-hash="md5-rrKGt1uuy7NHZ00ULUyPmQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Analysis of malicious documents – Part 04 – Defensive measures, next steps, and closure</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/analysis-of-malicious-documents-part-02-pdf-documents/">
        
        
            <div class="article-image">
                <img src="/p/analysis-of-malicious-documents-part-02-pdf-documents/13.9fc6d1d131919eee16849d6694281c26_hu240fb05a8481aa980793c3ec9617edae_85474_250x150_fill_box_smart1_3.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Analysis of malicious documents – Part 02 – PDF documents"
                        
                        data-hash="md5-n8bR0TGRnu4WhJ1mlCgcJg==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Analysis of malicious documents – Part 02 – PDF documents</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/analysis-of-malicious-documents-part-01-introduction-and-vms/">
        
        
            <div class="article-image">
                <img src="/p/analysis-of-malicious-documents-part-01-introduction-and-vms/6.b50246bde9b1d2f15ed77edc7999985e_hu71091bd9fd3cc51e63e3804503417e43_60794_250x150_fill_q75_box_smart1.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Analysis of malicious documents – Part 01 – Introduction and VMs"
                        
                        data-hash="md5-tQJGvemx0vFe137ceZmYXg==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Analysis of malicious documents – Part 01 – Introduction and VMs</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/sda-safe-and-documented-for-activism-sda-seguros-y-documentados-para-el-activismo/">
        
        
            <div class="article-image">
                <img src="/p/sda-safe-and-documented-for-activism-sda-seguros-y-documentados-para-el-activismo/sda.20fce1dedb42d131e7757f05163f36ec_hu5a8ad7f9d9c6297e9afdcb725f5bca37_30238_250x150_fill_box_smart1_3.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post SDA: Safe and documented for activism | SDA: Seguros y documentados para el activismo"
                        
                        data-hash="md5-IPzh3ttC0THndX8FFj827A==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">SDA: Safe and documented for activism | SDA: Seguros y documentados para el activismo</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/analysis-of-malicious-documents-bonus-blog-post-more-recent-techniques-in-attacks-with-malicious-documents/">
        
        
            <div class="article-image">
                <img src="/p/analysis-of-malicious-documents-bonus-blog-post-more-recent-techniques-in-attacks-with-malicious-documents/1.b4a1092850d9c8a78babc75343a6b125_hu36a617cf5e3c297ddbde091be7327273_36258_250x150_fill_q75_box_smart1.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Analysis of malicious documents – Bonus blog post – More recent techniques in attacks with malicious documents  "
                        
                        data-hash="md5-tKEJKFDZyKeLq8dTQ6axJQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Analysis of malicious documents – Bonus blog post – More recent techniques in attacks with malicious documents  </h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2025 Carlos Guerra
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
